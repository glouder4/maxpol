# Парсер транскрибации Bitrix24

Google Apps Script для автоматической обработки данных транскрибации разговоров из Bitrix24, парсинга JSON и обновления полей контактов и сделок в CRM.

## Описание

В облачной версии Bitrix24 транскрибация разговоров сохраняет результаты в виде JSON строки в пользовательском поле контакта. Данный скрипт выполняет роль промежуточного обработчика, который:

- Получает webhook-запросы от Bitrix24 (после завершения транскрибации)
- Извлекает JSON строку с данными транскрибации из пользовательского поля контакта
- Парсит JSON и извлекает структурированные данные (готовность работать с менеджером, готовность ехать к заказчику, срочность, деньги)
- Обновляет соответствующие списковые поля контакта в Bitrix24
- Синхронизирует данные в связанные сделки
- Логирует все операции в Google Таблицу

**Почему нужен внешний скрипт?** В облачной версии Bitrix24 ограничены возможности выполнения сложной логики обработки данных напрямую, поэтому используется внешний обработчик на базе Google Apps Script.

## Функциональность

- ✅ Получение JSON данных транскрибации из поля контакта Bitrix24
- ✅ Парсинг JSON и извлечение структурированных полей
- ✅ Автоматическое обновление списковых полей контакта в Bitrix24
- ✅ Синхронизация данных из контакта в связанные сделки
- ✅ Защита от повторной обработки сделок (через флаг обработки)
- ✅ Запись всех данных в Google Таблицу для логирования
- ✅ Детальное логирование всех операций с контрольными точками

## Требования

- Аккаунт Google с доступом к Google Sheets
- Аккаунт Bitrix24 с настроенными webhook'ами
- Доступ к Bitrix24 REST API
- Google Таблица для логирования данных

## Установка

### 1. Создание Google Apps Script проекта

1. Откройте [Google Apps Script](https://script.google.com/)
2. Создайте новый проект
3. Скопируйте содержимое файла `main.gs` в редактор
4. Сохраните проект (Ctrl+S)

### 2. Создание Google Таблицы

1. Создайте новую Google Таблицу
2. Скопируйте ID таблицы из URL (часть между `/d/` и `/edit`)
3. Вставьте ID в константу `SHEET_ID` в начале файла `main.gs`

```javascript
const SHEET_ID = 'ВАШ_ID_ТАБЛИЦЫ';
```

### 3. Настройка Webhook'ов в Bitrix24

Вам понадобятся следующие webhook'и в Bitrix24 (создаются в разделе "Разработчикам → Другое → Вебхуки"):

1. **Входящий webhook для получения данных контакта** (`crm.contact.get`) - используется в функции `getContactFields` для чтения поля с JSON транскрибации
2. **Входящий webhook для обновления контакта** (`crm.contact.update`) - используется в `updateContactInBitrix24` для обновления списковых полей
3. **Входящий webhook для получения списка сделок** (`crm.deal.list`) - используется в `getContactDeals`
4. **Входящий webhook для обновления сделок** (`crm.deal.update`) - используется в `updateDealsWithContactData`

Обновите соответствующие константы в коде:
- `UPDATE_WEBHOOK_URL` - URL webhook'а для обновления контакта
- `DEAL_UPDATE_WEBHOOK_URL` - URL webhook'а для обновления сделок
- URL в функции `getContactFields()` - URL webhook'а для получения данных контакта
- URL в функции `getContactDeals()` - URL webhook'а для получения сделок

### 4. Развертывание как веб-приложения

1. В редакторе Google Apps Script выберите **Развернуть → Новое развертывание**
2. Выберите тип: **Веб-приложение**
3. Настройки:
   - **Выполнять от имени**: ваш аккаунт
   - **У кого есть доступ**: все (или по необходимости)
4. Нажмите **Развернуть**
5. Скопируйте **URL веб-приложения** - это ваш webhook endpoint

### 5. Настройка автоматизации в Bitrix24

Для автоматического вызова скрипта после транскрибации необходимо настроить автоматизацию в Bitrix24:

1. Перейдите в **Автоматизации → Бизнес-процессы** или **Триггеры**
2. Создайте триггер/автоматизацию на событие изменения контакта (или конкретного поля с транскрибацией)
3. В действии выберите **HTTP-запрос** (или **Вебхук**)
4. Укажите URL вашего Google Apps Script веб-приложения
5. В параметрах запроса передайте ID контакта (например, `document_id[1]` или `id`)

**Альтернативный вариант:** Если транскрибация сохраняется в поле сделки/лида, настройте триггер на соответствующую сущность.

## Конфигурация

### Основные константы

```javascript
// ID Google Таблицы
const SHEET_ID = '';

// Названия листов
const CONTACTS_SHEET_NAME = 'Логи запросов';
const DEBUG_LOG_SHEET_NAME = 'Логи отладки';

// ID пользовательского поля Bitrix24, где хранится JSON строка с данными транскрибации
const FORM_DATA_FIELD_ID = 'UF_CRM_1761752668447';
```

### Формат JSON транскрибации

Скрипт ожидает JSON строку в следующем формате (хранится в поле `FORM_DATA_FIELD_ID`):

```json
{
  "custom": {
    "Gotovnost_ehat_na_vstrechu_k_zastroyshchiku": "ДА",
    "Gotovnost_rabotat_s_menedzherom": "ДА",
    "Srochnost": "ГОТОВ КУПИТЬ СЕЙЧАС",
    "Dengi": "СВОИ"
  }
}
```

### Извлекаемые и синхронизируемые поля

Скрипт извлекает из JSON транскрибации и синхронизирует следующие поля:

- **Готовность ехать к заказчику** (`gotovnostEhat`) - из `Gotovnost_ehat_na_vstrechu_k_zastroyshchiku`
- **Готовность работать с менеджером** (`gotovnostRabotat`) - из `Gotovnost_rabotat_s_menedzherom`
- **Срочность** (`srochnost`) - из `Srochnost`
- **Деньги** (`dengi`) - из `Dengi`

### Маппинг значений

Поскольку в Bitrix24 списковые поля используют ID элементов, а транскрибация возвращает текстовые значения, в скрипте настроены два маппинга:

- `LIST_VALUE_MAPPING` - сопоставление текстовых значений из транскрибации на ID элементов списковых полей контактов
- `DEAL_LIST_VALUE_MAPPING` - сопоставление текстовых значений на ID элементов списковых полей сделок

**Важно:** Если структура списков в Bitrix24 изменится или добавятся новые значения, необходимо обновить соответствующие маппинги в коде.

## Использование

### Инициализация таблицы (первый запуск)

1. В редакторе Google Apps Script выберите функцию `initializeSheet`
2. Нажмите **Выполнить**
3. Это создаст лист "Логи запросов" с заголовками

### Процесс обработки транскрибации

Скрипт автоматически обрабатывает POST-запросы от Bitrix24. При получении запроса выполняется следующая последовательность:

1. **Извлечение ID контакта** - из параметров webhook-запроса (поддерживаются различные форматы: `document_id[1]`, `id`, `contact_id` и др.)
2. **Получение данных контакта** - через Bitrix24 REST API извлекается пользовательское поле с JSON строкой транскрибации
3. **Парсинг JSON** - из JSON строки извлекается объект `custom` с данными транскрибации
4. **Извлечение полей** - из объекта `custom` извлекаются нужные поля (готовность ехать, готовность работать, срочность, деньги)
5. **Логирование** - все извлеченные данные записываются в Google Таблицу
6. **Обновление контакта** - текстовые значения конвертируются в ID списковых элементов и обновляются в контакте Bitrix24
7. **Обновление сделок** - связанные с контактом сделки синхронизируются теми же данными (если они еще не были обработаны)

### Формат ответа

Успешный ответ:
```json
{
  "status": "success",
  "message": "Данные успешно получены и записаны в таблицу",
  "contactId": "123",
  "deals": [...],
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

Ошибка:
```json
{
  "status": "error",
  "message": "Ошибка при обработке запроса",
  "error": "Описание ошибки"
}
```

## Структура проекта

```
main.gs
├── Константы и конфигурация
│   ├── SHEET_ID - ID Google Таблицы
│   ├── Webhook URLs - URL webhook'ов Bitrix24 REST API
│   ├── FORM_DATA_FIELD_ID - ID поля с JSON транскрибации
│   ├── BITRIX_FIELDS - маппинг названий полей в JSON
│   ├── BITRIX_FIELD_IDS - маппинг ID полей Bitrix24
│   └── LIST_VALUE_MAPPING / DEAL_LIST_VALUE_MAPPING - маппинг значений
│
├── Основные функции обработки
│   ├── doPost(e) - точка входа для webhook запросов
│   ├── extractContactId(e) - извлечение ID контакта из запроса
│   └── getContactFields(contactId) - получение и парсинг JSON транскрибации
│
├── Функции обновления Bitrix24
│   ├── updateContactInBitrix24() - обновление списковых полей контакта
│   └── updateDealsWithContactData() - синхронизация данных в сделки
│
├── Работа с Google Sheets
│   ├── writeToSheet() - запись данных в таблицу
│   ├── initializeSheet() - инициализация таблицы (первый запуск)
│   └── formatSheetHeader() - форматирование заголовков
│
└── Вспомогательные функции
    ├── logToSheet() - логирование в консоль/таблицу
    ├── logCheckpoint() - логирование с измерением времени
    ├── normalizeFieldValue() - нормализация текстовых значений
    └── isBitrixCheckboxChecked() - проверка флагов обработки
```

## Формат данных в Google Таблице

Таблица "Логи запросов" содержит следующие колонки:

| Колонка | Описание |
|---------|----------|
| Время | ISO-формат временной метки запроса |
| ID контакта | ID контакта в Bitrix24 |
| Готовность ехать к заказчику | Значение из формы |
| Готовность работать с менеджером | Значение из формы |
| Срочность | Значение из формы |
| Деньги | Значение из формы |

## Важные замечания

### Безопасность

⚠️ **Внимание**: Webhook URLs содержат токены доступа. Храните их в безопасности и не делитесь файлом с кем-либо.

⚠️ Не коммитьте файл с реальными webhook URLs в публичные репозитории.

### Обработка сделок

- Сделки обрабатываются только один раз (проверяется флаг `UF_CRM_1761643310581`)
- Если флаг установлен, сделка пропускается (защита от повторной обработки)
- После успешного обновления сделки, флаг автоматически устанавливается в `true`
- Данные из контакта синхронизируются во все связанные сделки, которые еще не были обработаны

### Логирование

- По умолчанию функция `logToSheet()` выводит логи только в консоль Google Apps Script
- Для записи логов в Google Таблицу (лист "Логи отладки") раскомментируйте соответствующий код в функции `logToSheet()`
- Все данные транскрибации автоматически записываются в лист "Логи запросов" для истории

### Производительность

Скрипт использует контрольные точки (`logCheckpoint`) для отслеживания времени выполнения каждого этапа обработки. Это помогает выявлять узкие места.

## Отладка

1. **Просмотр логов**: Перейдите в **Выполнение** в Google Apps Script для просмотра логов
2. **Тестирование функций**: Используйте встроенный отладчик Google Apps Script
3. **Проверка webhook**: Используйте Postman или curl для отправки тестовых POST-запросов

### Пример тестового запроса

```bash
curl -X POST https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec \
  -H "Content-Type: application/json" \
  -d '{"id": "123"}'
```

## Поддержка и устранение неполадок

При возникновении проблем проверьте:

1. **Правильность ID Google Таблицы** - убедитесь, что константа `SHEET_ID` заполнена
2. **Корректность webhook URLs** - все webhook'и должны быть валидными и иметь нужные права доступа
3. **ID поля с транскрибацией** - проверьте, что `FORM_DATA_FIELD_ID` соответствует реальному ID поля в Bitrix24
4. **Формат JSON транскрибации** - убедитесь, что структура JSON соответствует ожидаемой (должен быть объект `custom`)
5. **Названия полей в JSON** - проверьте соответствие ключей в `BITRIX_FIELDS` реальным названиям полей в JSON
6. **Маппинг значений** - убедитесь, что все текстовые значения из транскрибации присутствуют в `LIST_VALUE_MAPPING` и `DEAL_LIST_VALUE_MAPPING`
7. **Права доступа** - webhook'и должны иметь права на чтение контактов и обновление контактов/сделок
8. **Автоматизация Bitrix24** - проверьте, что триггер правильно настроен и вызывает ваш webhook

### Частые проблемы

**Проблема:** Скрипт не находит данные транскрибации
- **Решение:** Проверьте, что поле `FORM_DATA_FIELD_ID` действительно содержит JSON строку после транскрибации

**Проблема:** Значения не обновляются в Bitrix24
- **Решение:** Убедитесь, что текстовые значения из транскрибации точно соответствуют ключам в маппинге (учитывается регистр после нормализации)

**Проблема:** Сделки не обновляются
- **Решение:** Проверьте, что сделки связаны с контактом через поле `CONTACT_ID` и что флаг обработки еще не установлен

## Лицензия

Проект для внутреннего использования.

