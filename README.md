# Интеграция Bitrix24 с Google Sheets

Google Apps Script для автоматической синхронизации данных контактов и сделок между Bitrix24 CRM и Google Таблицами.

## Описание

Скрипт обрабатывает webhook-запросы от Bitrix24, извлекает данные контактов (готовность работать с менеджером, готовность ехать к заказчику, срочность, деньги), записывает их в Google Таблицу и автоматически обновляет соответствующие поля в контактах и связанных сделках Bitrix24.

## Функциональность

- ✅ Получение данных контакта из Bitrix24 через REST API
- ✅ Запись данных в Google Таблицу с временными метками
- ✅ Автоматическое обновление списковых полей контакта в Bitrix24
- ✅ Синхронизация данных из контакта в связанные сделки
- ✅ Защита от повторной обработки сделок (через флаг обработки)
- ✅ Детальное логирование всех операций

## Требования

- Аккаунт Google с доступом к Google Sheets
- Аккаунт Bitrix24 с настроенными webhook'ами
- Доступ к Bitrix24 REST API
- Google Таблица для логирования данных

## Установка

### 1. Создание Google Apps Script проекта

1. Откройте [Google Apps Script](https://script.google.com/)
2. Создайте новый проект
3. Скопируйте содержимое файла `main.gs` в редактор
4. Сохраните проект (Ctrl+S)

### 2. Создание Google Таблицы

1. Создайте новую Google Таблицу
2. Скопируйте ID таблицы из URL (часть между `/d/` и `/edit`)
3. Вставьте ID в константу `SHEET_ID` в начале файла `main.gs`

```javascript
const SHEET_ID = 'ВАШ_ID_ТАБЛИЦЫ';
```

### 3. Настройка Webhook'ов в Bitrix24

Вам понадобятся следующие webhook'и в Bitrix24:

1. **Webhook для получения данных контакта** - используется в функции `getContactFields`
2. **Webhook для обновления контакта** - используется в `updateContactInBitrix24`
3. **Webhook для получения списка сделок** - используется в `getContactDeals`
4. **Webhook для обновления сделок** - используется в `updateDealsWithContactData`

Обновите соответствующие константы в коде:
- `UPDATE_WEBHOOK_URL` - для обновления контакта
- `DEAL_UPDATE_WEBHOOK_URL` - для обновления сделок
- URL в функции `getContactFields()` - для получения данных контакта
- URL в функции `getContactDeals()` - для получения сделок

### 4. Развертывание как веб-приложения

1. В редакторе Google Apps Script выберите **Развернуть → Новое развертывание**
2. Выберите тип: **Веб-приложение**
3. Настройки:
   - **Выполнять от имени**: ваш аккаунт
   - **У кого есть доступ**: все (или по необходимости)
4. Нажмите **Развернуть**
5. Скопируйте **URL веб-приложения** - это ваш webhook endpoint

### 5. Настройка webhook в Bitrix24

1. Перейдите в настройки Bitrix24 → Разработчикам → Другое → Вебхуки
2. Создайте новый входящий webhook для события обновления контакта
3. Укажите URL вашего Google Apps Script веб-приложения

## Конфигурация

### Основные константы

```javascript
// ID Google Таблицы
const SHEET_ID = '';

// Названия листов
const CONTACTS_SHEET_NAME = 'Логи запросов';
const DEBUG_LOG_SHEET_NAME = 'Логи отладки';

// ID пользовательских полей Bitrix24
const FORM_DATA_FIELD_ID = 'UF_CRM_1761752668447'; // Поле-контейнер с данными формы
```

### Поля для синхронизации

Скрипт синхронизирует следующие поля:

- **Готовность ехать к заказчику** (`gotovnostEhat`)
- **Готовность работать с менеджером** (`gotovnostRabotat`)
- **Срочность** (`srochnost`)
- **Деньги** (`dengi`)

### Маппинг значений

В файле настроены два маппинга значений для списковых полей:

- `LIST_VALUE_MAPPING` - для полей контактов
- `DEAL_LIST_VALUE_MAPPING` - для полей сделок

Каждое текстовое значение сопоставляется с соответствующим ID элемента списка в Bitrix24.

## Использование

### Инициализация таблицы (первый запуск)

1. В редакторе Google Apps Script выберите функцию `initializeSheet`
2. Нажмите **Выполнить**
3. Это создаст лист "Логи запросов" с заголовками

### Работа с webhook

Скрипт автоматически обрабатывает POST-запросы от Bitrix24. При получении запроса:

1. Извлекается ID контакта из параметров запроса
2. Получаются данные контакта из Bitrix24
3. Данные записываются в Google Таблицу
4. Обновляются поля контакта в Bitrix24 (если есть данные для обновления)
5. Обновляются связанные сделки контакта

### Формат ответа

Успешный ответ:
```json
{
  "status": "success",
  "message": "Данные успешно получены и записаны в таблицу",
  "contactId": "123",
  "deals": [...],
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

Ошибка:
```json
{
  "status": "error",
  "message": "Ошибка при обработке запроса",
  "error": "Описание ошибки"
}
```

## Структура проекта

```
main.gs
├── Константы и конфигурация
│   ├── SHEET_ID
│   ├── Webhook URLs
│   ├── Маппинг полей и значений
│   └── ID пользовательских полей
│
├── Основные функции
│   ├── doPost(e) - точка входа для webhook
│   ├── extractContactId(e) - извлечение ID контакта
│   └── getContactFields(contactId) - получение данных контакта
│
├── Функции обновления Bitrix24
│   ├── updateContactInBitrix24() - обновление контакта
│   └── updateDealsWithContactData() - обновление сделок
│
├── Работа с Google Sheets
│   ├── writeToSheet() - запись данных
│   ├── initializeSheet() - инициализация таблицы
│   └── formatSheetHeader() - форматирование заголовков
│
└── Вспомогательные функции
    ├── logToSheet() - логирование
    ├── normalizeFieldValue() - нормализация значений
    └── isBitrixCheckboxChecked() - проверка чекбоксов
```

## Формат данных в Google Таблице

Таблица "Логи запросов" содержит следующие колонки:

| Колонка | Описание |
|---------|----------|
| Время | ISO-формат временной метки запроса |
| ID контакта | ID контакта в Bitrix24 |
| Готовность ехать к заказчику | Значение из формы |
| Готовность работать с менеджером | Значение из формы |
| Срочность | Значение из формы |
| Деньги | Значение из формы |

## Важные замечания

### Безопасность

⚠️ **Внимание**: Webhook URLs содержат токены доступа. Храните их в безопасности и не делитесь файлом с кем-либо.

⚠️ Не коммитьте файл с реальными webhook URLs в публичные репозитории.

### Обработка сделок

- Сделки обрабатываются только один раз (проверяется флаг `UF_CRM_1761643310581`)
- Если флаг установлен, сделка пропускается
- После обновления сделки, флаг автоматически устанавливается в `true`

### Логирование

По умолчанию функция `logToSheet()` выводит логи только в консоль Google Apps Script. Для записи в таблицу раскомментируйте соответствующий код в функции.

### Производительность

Скрипт использует контрольные точки (`logCheckpoint`) для отслеживания времени выполнения каждого этапа обработки. Это помогает выявлять узкие места.

## Отладка

1. **Просмотр логов**: Перейдите в **Выполнение** в Google Apps Script для просмотра логов
2. **Тестирование функций**: Используйте встроенный отладчик Google Apps Script
3. **Проверка webhook**: Используйте Postman или curl для отправки тестовых POST-запросов

### Пример тестового запроса

```bash
curl -X POST https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec \
  -H "Content-Type: application/json" \
  -d '{"id": "123"}'
```

## Поддержка

При возникновении проблем проверьте:

1. Правильность ID Google Таблицы
2. Корректность webhook URLs
3. Доступность всех необходимых полей в Bitrix24
4. Правильность маппинга значений в `LIST_VALUE_MAPPING` и `DEAL_LIST_VALUE_MAPPING`
5. Права доступа к Google Таблице и Bitrix24 API

## Лицензия

Проект для внутреннего использования.

